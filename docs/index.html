<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>近所イベント検索（相模原）</title>
  <style>
    /* —— 明るいトーン —— */
    :root{
      --bg:#f6f9fc;
      --card:#ffffff;
      --ink:#1b2630;
      --muted:#5a6b77;
      --line:#e3ecf2;
      --accent:#0ea5e9; /* ボタン */
      --ok:#10b981;     /* スコア */
      --chip:#eef6fb;
      --chip-on:#dff1ff;
      --skeleton1:#eef4f8;
      --skeleton2:#e7f0f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(800px 300px at 20% -10%, #ffffff 0%, #f2f8ff 40%, #f6f9fc 100%);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP",sans-serif
    }
    header{
      position:sticky;top:0;z-index:5;
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid var(--line)
    }
    .hrow{display:flex;gap:8px;align-items:center;padding:10px 12px}
    .logo{font-weight:800;letter-spacing:.02em}
    .loc{margin-left:auto;font-size:12px;color:var(--muted)}
    .search{display:flex;gap:8px;padding:6px 12px 12px}
    .search input{
      flex:1;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;color:var(--ink);box-shadow:0 1px 0 #00000008 inset
    }
    .btn{
      display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);background:#fff;color:var(--ink);cursor:pointer
    }
    .btn.primary{
      background:linear-gradient(90deg,#38bdf8,#0ea5e9);color:#073042;border:0;font-weight:700
    }
    .toolbar{display:flex;gap:8px;padding:0 12px 10px;overflow-x:auto}
    .chip{
      white-space:nowrap;border:1px solid var(--line);background:var(--chip);
      padding:8px 10px;border-radius:999px;font-size:13px;cursor:pointer;color:#0b3a4c
    }
    .chip.active{outline:2px solid #bfe7ff;background:var(--chip-on)}

    main{padding:12px;max-width:720px;margin:0 auto}
    .cards{display:grid;grid-template-columns:1fr;gap:10px}
    .card{
      border:1px solid var(--line);background:var(--card);border-radius:16px;overflow:hidden;
      box-shadow:0 6px 16px rgba(8,38,58,.06)
    }
    .ph{height:120px;background:linear-gradient(120deg,#e6f6ff,#f3fbff)}
    .body{padding:10px 12px}
    h3{margin:2px 0 6px;font-size:16px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .tag{font-size:11px;background:#e6f6ff;border:1px solid #d1ecff;border-radius:999px;padding:3px 8px;color:#06445a}
    .cta{display:flex;gap:8px;padding:10px 12px 12px}
    .score{margin-left:auto;font-weight:700;color:#054; background:#c7f7e6;border:1px solid #aaf1d6;border-radius:10px;padding:4px 8px}

    .skeleton{
      height:92px;border:1px solid var(--line);border-radius:14px;
      background:linear-gradient(90deg,var(--skeleton1) 0%,var(--skeleton2) 40%,var(--skeleton1) 80%);
      background-size:200% 100%;animation:sk 1.2s infinite
    }
    @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

    footer{
      position:sticky;bottom:0;background:rgba(255,255,255,.85);
      backdrop-filter:blur(8px);border-top:1px solid var(--line);padding:8px 12px
    }
    .sources{display:flex;gap:8px;overflow-x:auto}
    .src{white-space:nowrap;font-size:12px;border:1px solid var(--line);padding:8px 10px;border-radius:10px;background:#fff}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="hrow">
      <div class="logo">近所イベント（相模原）</div>
      <div class="loc" id="loc">位置未取得</div>
    </div>
    <div class="search">
      <input id="q" placeholder="例：おすすめ／苔／手芸／木工／花屋／科学館" />
      <button class="btn" id="geo">現在地</button>
      <button class="btn primary" id="go">検索</button>
    </div>
    <div class="toolbar" id="chips"></div>
  </header>

  <main>
    <div id="list" class="cards"></div>
    <div id="empty" class="muted" style="padding:12px;display:none">（APIが空です）キーワードを変える／再検索してください。</div>
  </main>

  <footer>
    <div class="sources" id="sources"></div>
  </footer>

  
<script>

  // APIのベースURLを環境で切り替える
const API_BASE =
  location.hostname.endsWith('github.io')
    ? 'https://nearby-events-gemini2.vercel.app/api' // GitHub Pages → VercelのAPIを叩く
    : '/api';                                        // Vercel環境 → 相対でOK

// タブ（プリセット）：先頭を「自然」に。おすすめは削除
const PRESETS = ["自然","苔","手芸","編み物","木工","花屋","科学館","ガラス","竹細工"];

// 位置
const locEl = document.getElementById('loc');
let LOC = { lat:35.5710, lon:139.3707 };
function updateLocLabel(){ locEl.textContent = `${LOC.lat.toFixed(3)}, ${LOC.lon.toFixed(3)}` }
updateLocLabel();

// カード描画
function render(items){
  const list=document.getElementById('list');
  const empty=document.getElementById('empty');
  list.innerHTML='';
  if(!items.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  items.forEach(({it,meta})=>{
    const tags = (it.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('');
    const el=document.createElement('article'); el.className='card';
    el.innerHTML = `
      <div class="ph"></div>
      <div class="body">
        <h3>${it.title||'（無題）'}</h3>
        <div class="meta">
          <span>${it.place||''}</span>
          <span>距離 ${meta.d??'?'}km</span>
          <span>価格 ${typeof it.price==='number' ? (it.price+'円') : '無料/未定'}</span>
          <span>目安 ${it.when||'要確認'}</span>
          <span class="score">${meta.s??0}</span>
        </div>
        <div class="tags">${tags}</div>
      </div>
      <div class="cta">
        <button class="btn" onclick="openMap(${it.lat||LOC.lat},${it.lon||LOC.lon}, '${(it.title||'').replace(/'/g,"\\'")}')">地図</button>
        <a class="btn primary" href="${it.url||'#'}" target="_blank" rel="noopener">予約/詳細</a>
      </div>`;
    list.appendChild(el);
  });
}
function openMap(lat,lon,title){
  const q=encodeURIComponent(`${lat},${lon} (${title})`);
  window.open(`https://www.google.com/maps/search/?api=1&query=${q}`,'_blank');
}

// 検索（APIのみ使用）
async function search(){
  const q = document.getElementById('q').value.trim();
  const list = document.getElementById('list');
  list.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>';

  const url = new URL(`${API_BASE}/events`);
  url.searchParams.set('q', q);
  url.searchParams.set('lat', LOC.lat);
  url.searchParams.set('lon', LOC.lon);
  url.searchParams.set('radius', 8);
  url.searchParams.set('fresh', '1');
  url.searchParams.set('debug', '0');

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (Array.isArray(data) && data.length) {
      const ranked = data.map(it => {
        const d = (typeof it.distance_km === 'number') ? it.distance_km.toFixed(1) : '?';
        return { it: {
          title: it.title||'（無題）',
          tags: Array.isArray(it.tags)?it.tags:[],
          place: it.place||'',
          lat: (typeof it.lat==='number')?it.lat:LOC.lat,
          lon: (typeof it.lon==='number')?it.lon:LOC.lon,
          price: (typeof it.price==='number')?it.price:null,
          when: it.when||'',
          url: it.url||'#',
          source: 'API'
        }, meta:{ s: it.score??0, d }};
      });
      render(ranked);
      updateSourceLinks(q || '自然 観察 体験');
      return;
    }
    render([]);
    updateSourceLinks(q || '自然 観察 体験');
  } catch (e) {
    console.warn('API error', e);
    render([]);
    updateSourceLinks(q || '自然 観察 体験');
  }
}

// 現在地ボタン
document.getElementById('geo').addEventListener('click',()=>{
  if(!navigator.geolocation){alert('位置情報が使えません');return}
  navigator.geolocation.getCurrentPosition((p)=>{
    LOC={lat:p.coords.latitude,lon:p.coords.longitude};
    updateLocLabel();
    search();
  },()=>{alert('位置情報の取得に失敗しました')},{enableHighAccuracy:true,timeout:8000});
});

// タブ生成（「自然」を最初に追加、クリックでqにセット→検索）
const chipsEl=document.getElementById('chips');
PRESETS.forEach(t=>{
  const b=document.createElement('button'); b.className='chip'; b.textContent=t;
  b.addEventListener('click',()=>{
    document.getElementById('q').value=t;
    search();
    [...document.querySelectorAll('.chip')].forEach(c=>c.classList.toggle('active', c.textContent===t));
  });
  chipsEl.appendChild(b);
});

// 初期表示：自然タブを選択＆自動検索（q="自然"）
window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('q').value = '自然';
  const firstChip = document.querySelector('.chip');
  if (firstChip) firstChip.classList.add('active'); // 「自然」
  search();
});

// 検索ボタン/Enter
document.getElementById('go').addEventListener('click', search);
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(); });

// フッターの外部リンク
function updateSourceLinks(q){
  const area = '相模原';
  const kw = encodeURIComponent(q||'自然 観察 体験');
  const box=document.getElementById('sources');
  box.innerHTML='';
  const links=[
    {name:'じゃらん', url:`https://www.jalan.net/kankou/?word=${kw}`},
    {name:'相模原市 公式', url:`https://www.google.com/search?q=${encodeURIComponent('site:city.sagamihara.kanagawa.jp ')}${kw}`},
    {name:'YouTube', url:`https://www.youtube.com/results?search_query=${encodeURIComponent(area+' '+(q||'自然 観察 体験'))}`}
  ];
  links.forEach(l=>{
    const a=document.createElement('a'); a.href=l.url; a.target='_blank'; a.rel='noopener'; a.className='src'; a.textContent=l.name+'で探す'; box.appendChild(a);
  })
}
updateSourceLinks('');
</script>

</body>
</html>
