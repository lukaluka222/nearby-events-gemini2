<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>先輩の人生マップ</title>
<style>
  :root{
    --bg:#fffcf6; --ink:#1e293b; --muted:#6b7280;
    --card:#ffffff; --border:#eef2f7; --accent:#6b8cff;
    --purple:#a78bfa; --gray:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto}
  header{position:sticky;top:0;background:linear-gradient(#fff,rgba(255,255,255,.9));
    backdrop-filter:saturate(1.2) blur(6px);padding:12px 16px;border-bottom:1px solid var(--border)}
  .title{font-weight:700}
  .wrap{max-width:420px;margin:0 auto;padding:12px}
  .canvas{position:relative;aspect-ratio:9/16;background:linear-gradient(180deg,#fff 0%, #fffaf3 100%);
    border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 6px 16px rgba(0,0,0,.06)}
  svg{position:absolute;inset:0}
  .node{position:absolute;transform:translate(-50%,-50%);width:84px}
  .dot{width:24px;height:24px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.15)}
  .bubble{margin-top:8px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px;
    font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
  .dot.purple{background:var(--purple)}
  .dot.gray{background:var(--gray)}
  .legend{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;margin:8px 0}
  .legend .sw{width:12px;height:12px;border-radius:50%}
  /* モーダル */
  dialog{border:none;border-radius:16px;max-width:520px;width:92vw;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  dialog::backdrop{background:rgba(0,0,0,.25)}
  .modal-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
  .modal-b{padding:16px}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700}
</style>

<header><div class="title">るかさんの人生マップ（見本）</div></header>
<div class="wrap">
  <div class="canvas" id="canvas">
    <!-- 背景のS字パス（見た目用） -->
    <svg viewBox="0 0 390 700" preserveAspectRatio="xMidYMid meet">
      <defs>
        <filter id="soft"><feGaussianBlur in="SourceGraphic" stdDeviation="3" /></filter>
      </defs>
      <path id="track" d="M40,40 C180,20 210,120 350,100
                           C210,130 180,240 40,220
                           C180,260 210,360 350,340
                           C210,380 180,480 40,460
                           C180,500 210,600 350,580" 
            fill="none" stroke="#efe6ff" stroke-width="28" filter="url(#soft)"/>
      <path d="M40,40 C180,20 210,120 350,100
               C210,130 180,240 40,220
               C180,260 210,360 350,340
               C210,380 180,480 40,460
               C180,500 210,600 350,580" 
            fill="none" stroke="#e9ecff" stroke-width="10" />
    </svg>
    <!-- ここにJSで10コマを配置 -->
  </div>

  <div class="legend">
    <span class="sw" style="background:#a78bfa"></span>強調コマ
    <span class="sw" style="background:#e5e7eb;margin-left:12px"></span>通常コマ
  </div>
</div>

<dialog id="dlg">
  <div class="modal-h" id="dlgTitle">詳細</div>
  <div class="modal-b" id="dlgBody"></div>
  <div style="padding:12px 16px;border-top:1px solid var(--border);text-align:right">
    <button onclick="dlg.close()">閉じる</button>
  </div>
</dialog>


 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ★ あなたの Firebase 設定に置き換え
  const firebaseConfig = {   apiKey: "AIzaSyDA1g7BFkCNJzWfedaAwpkLX_MypeQBA-Q",
  authDomain: "futoko-1f0db.firebaseapp.com",
  projectId: "futoko-1f0db"
                         };
   
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 画面に小さくデバッグ表示
  function showInfo(msg, isError=false){
    let el = document.getElementById("debugInfo");
    if(!el){
      el = document.createElement("div");
      el.id = "debugInfo";
      el.style.cssText = "position:fixed;left:8px;bottom:8px;background:#0008;color:#fff;padding:6px 8px;border-radius:8px;font:12px/1.4 system-ui;z-index:9999;max-width:90vw;word-break:break-all";
      document.body.appendChild(el);
    }
    el.textContent = (isError?"❌ ":"ℹ️ ")+msg;
  }

  // URLから mentorId を取得
  const mentorId = new URLSearchParams(location.search).get("id");
  if(!mentorId){
    showInfo("URLに ?id=<mentorId> を付けてください（例 /mentor-map.html?id=N4WaF...）", true);
    throw new Error("missing mentorId");
  } else {
    console.log("[mentorId]", mentorId);
    showInfo("mentorId: "+mentorId);
  }

  // 将来のルール変更に備えて匿名ログイン
  try {
    await signInAnonymously(auth);
    console.log("[auth] anon OK", auth.currentUser?.uid);
  } catch (e) {
    console.warn("[auth] anon failed", e);
  }

  // Firestoreから steps を取得（step 昇順）
  async function fetchSteps(){
    const q = query(collection(db, "mentors", mentorId, "steps"), orderBy("step", "asc"));
    const snap = await getDocs(q);
    const arr = snap.docs.map(d => d.data());
    // Console から見えるように外へ公開
    window.lastSteps = arr;
    console.log("[steps]", arr);
    return arr;
  }

  // 描画
  try {
    const steps = await fetchSteps();          // ← Firestoreから実データ
    if(!steps.length){
      showInfo("steps が空です。mentors/"+mentorId+"/steps に 01..10 があるか、step が number 型か確認してください。", true);
    }

    // 既存のSVG/要素がある前提（id="track","canvas","dlg","dlgTitle","dlgBody"）
    const path = document.getElementById("track");
    const length = path.getTotalLength();
    const canvas = document.getElementById("canvas");
    const tPositions = [0.03,0.13,0.22,0.31,0.40,0.49,0.58,0.69,0.80,0.92];

    const dlg = document.getElementById("dlg");
    const dlgTitle = document.getElementById("dlgTitle");
    const dlgBody = document.getElementById("dlgBody");

    // いったん古いノードを消す（再読み込み対策）
    [...canvas.querySelectorAll(".node")].forEach(n=>n.remove());

    steps.forEach((s, i) => {
      const t = tPositions[i] ?? (i/(steps.length-1));
      const p = path.getPointAtLength(length * t);
      const node = document.createElement("div");
      node.className = "node";
      node.style.left = p.x+"px";
      node.style.top  = p.y+"px";
      node.innerHTML = `
        <div class="dot ${s.color === "purple" ? "purple" : "gray"}"></div>
        <div class="bubble">${escapeHtml(s.text)}</div>
      `;
      node.onclick = () => {
        dlgTitle.textContent = `第${s.step}コマ`;
        dlgBody.textContent  = s.detail || "詳細は準備中です。";
        dlg.showModal();
      };
      canvas.appendChild(node);
    });

    showInfo("表示OK（steps: "+steps.length+"件）");
  } catch (e) {
    console.error(e);
    showInfo("読み込み/描画エラー: "+(e.message||e), true);
  }

  function escapeHtml(str){
    return (str||"").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[s]));
  }
</script>

  

</html>
