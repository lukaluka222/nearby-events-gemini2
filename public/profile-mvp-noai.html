<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«MVPï¼ˆAIãªã—ï¼‰</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px}
  .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
  .card{border:1px solid #ddd;border-radius:10px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .messages{height:280px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fafafa}
  .msg{margin:6px 0}
  .msg.me{ text-align:right }
  textarea{width:100%;min-height:80px}
  input,button,select{padding:8px;font-size:14px}
  pre{background:#f6f8fa;padding:10px;overflow:auto}
  .chip{padding:4px 8px;border:1px solid #aaa;border-radius:999px;background:#fff;cursor:pointer}
  .chip.active{background:#333;color:#fff;border-color:#333}
  .muted{color:#666;font-size:12px}
</style>
</head>
<body>
<h1>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆï¼ˆAIãªã—MVPï¼‰</h1>
<p class="muted">ä¼šè©±ã®ä¸­ã‹ã‚‰ç°¡å˜ãªãƒ«ãƒ¼ãƒ«ã§é …ç›®ã‚’æ‹¾ã„ã€å³ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«åæ˜ ã—ã¾ã™ã€‚ç·¨é›†â†’ä¿å­˜å¯èƒ½ã€‚</p>

<div class="card">
  <div class="row">
    <div>UID: <code id="uid">ï¼ˆæœªï¼‰</code></div>
    <button id="loginBtn">åŒ¿åãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
</div>

<div class="card">
  <h2>å­ã©ã‚‚ã‚’é¸ã¶ / ä½œã‚‹</h2>
  <div class="row">
    <input id="childName" placeholder="è¡¨ç¤ºåï¼ˆä¾‹ï¼šå¤ªéƒï¼‰"/>
    <input id="childAge" type="number" min="0" placeholder="å¹´é½¢ï¼ˆä»»æ„ï¼‰" style="width:140px"/>
    <button id="createChildBtn">ã“ã®å­ã‚’ä½œæˆ</button>
  </div>
  <div class="row" id="childrenList" style="margin-top:8px"></div>
  <div style="margin-top:8px">ç¾åœ¨ã®å­: <b id="currentChild">ï¼ˆæœªé¸æŠï¼‰</b></div>
</div>

<div class="grid">
  <div class="card">
    <h2>ãƒãƒ£ãƒƒãƒˆ</h2>
    <div class="messages" id="messages"></div>
    <div class="row" style="margin-top:8px">
      <input id="chatInput" placeholder="ä¾‹ï¼‰å¤§äººæ•°ã¨å¤§éŸ³é‡ã¯è‹¦æ‰‹ã€‚äºˆç®—ã¯2000å††ã€‚ç§»å‹•ã¯45åˆ†ã¾ã§ã€‚åˆå‰ãŒå…ƒæ°—ã€‚"/>
      <button id="sendBtn">é€ä¿¡</button>
    </div>
    <details style="margin-top:10px">
      <summary>å…¥åŠ›ã‚¢ã‚·ã‚¹ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ å…¥åŠ›ï¼‰</summary>
      <div class="row" style="margin-top:6px">
        <span class="chip">ç§‘å­¦å®Ÿé¨“ãŒå¥½ã</span>
        <span class="chip">æ‰‹èŠ¸ãŒå¥½ã</span>
        <span class="chip">é™ã‹ãªå ´æ‰€ãŒè‰¯ã„</span>
        <span class="chip">å±‹å†…ãŒè‰¯ã„</span>
        <span class="chip">å‹ã ã¡ã¨ä¸€ç·’OK</span>
        <span class="chip">ä¿è­·è€…åŒä¼´ãŒå¿…è¦</span>
        <span class="chip">åˆå‰ãŒå…ƒæ°—</span>
        <span class="chip">åœŸæ›œåˆå¾ŒãŒè‰¯ã„</span>
        <span class="chip">äººæ··ã¿ãŒè‹¦æ‰‹</span>
        <span class="chip">å¤§éŸ³é‡ãŒè‹¦æ‰‹</span>
      </div>
    </details>
    <p class="muted">â€» é€ä¿¡ã™ã‚‹ãŸã³ã«å³ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸è‡ªå‹•åæ˜ ã—ã¾ã™ï¼ˆãƒ«ãƒ¼ãƒ«æŠ½å‡ºï¼‰ã€‚</p>
  </div>

  <div class="card">
    <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆç·¨é›†å¯ï¼‰</h2>
    <pre id="profileJson">{}</pre>
    <div class="row">
      <button id="saveBtn">Firestoreã«ä¿å­˜</button>
      <button id="reloadBtn">Firestoreã‹ã‚‰å†èª­è¾¼</button>
    </div>
    <div class="muted" style="margin-top:6px">ä¿å­˜å…ˆ: parents/{uid}/profiles/{childId}</div>
  </div>
</div>

<!-- Firebase CDNï¼ˆv10ç³»ï¼‰ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, addDoc, collection, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // â˜… ã‚ãªãŸã®Firebaseè¨­å®šã‚’è²¼ã£ã¦ãã ã•ã„
  const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT"
  };

  // ---- åˆæœŸåŒ– ----
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const $ = id => document.getElementById(id);

  let uid = null;
  let currentChildId = null;
  let messages = []; // [{role:'parent', text:'...'}]

  // ---- ã‚¹ã‚­ãƒ¼ãƒï¼ˆå°†æ¥AIã¨äº’æ›ï¼‰ ----
  function emptyProfile(childId) {
    return {
      childId,
      basic: { displayName: "", age: null, schoolAttendance: null, preferredDaysOut: [] },
      interests: { categories: [], tags: [] },
      constraints: { budgetPerEventJPY: null, travelTimeMinutesMax: null, noiseSensitivity: null, crowdAversion: null, mobilityNotes: null },
      social: { preferredGroupSize: null, needsGuardian: null, friendTogetherOk: null },
      goals: { shortTerm: [], midTerm: [], longTerm: [] },
      safetyAndNotes: "",
      lastUpdated: new Date().toISOString()
    };
  }

  // ---- ãƒ«ãƒ¼ãƒ«æŠ½å‡ºï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ãªæ±ºã‚æ‰“ã¡ï¼‰----
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¾¤ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«åæ˜ ï¼ˆæ±ºã‚æ‰“ã¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼†æ­£è¦è¡¨ç¾ï¼‰
  function extractFromMessages(profile, msgs) {
    const text = msgs.map(m => m.text).join("ã€‚");

    // 1) äºˆç®—ï¼ˆä¾‹ï¼šã€Œ2000å††ã€ã€ŒÂ¥1500ã€ï¼‰
    const m1 = text.match(/([0-9]{3,6})\s*å††|Â¥\s*([0-9]{3,6})/);
    if (m1) {
      const val = Number(m1[1] || m1[2]);
      if (!isNaN(val)) profile.constraints.budgetPerEventJPY = val;
    }

    // 2) ç§»å‹•æ™‚é–“ï¼ˆã€Œ45åˆ†ã€ã€Œ1æ™‚é–“ã€ï¼‰
    const m2 = text.match(/([0-9]{1,2})\s*åˆ†/);
    const m2h = text.match(/([0-2])\s*æ™‚é–“/);
    if (m2) profile.constraints.travelTimeMinutesMax = Number(m2[1]);
    if (m2h) profile.constraints.travelTimeMinutesMax = Math.max(profile.constraints.travelTimeMinutesMax||0, Number(m2h[1])*60);

    // 3) è‹¦æ‰‹ãƒ»é…æ…®
    if (/å¤§éŸ³é‡|éŸ³ãŒå¤§ãã„|çˆ†éŸ³|é™ã‹ãª?å ´æ‰€ãŒ?è‰¯ã„/.test(text)) profile.constraints.noiseSensitivity = true;
    if (/äººæ··ã¿|æ··é›‘|å¤§äººæ•°ãŒ?è‹¦æ‰‹/.test(text)) profile.constraints.crowdAversion = true;

    // 4) å¥½ãï¼ˆã‚«ãƒ†ã‚´ãƒª/ã‚¿ã‚°ï¼‰
    const likeMap = [
      { re:/ç§‘å­¦(å®Ÿé¨“)?|ã‚µã‚¤ã‚¨ãƒ³ã‚¹|ç†ç§‘/, addCat:"ç§‘å­¦å®Ÿé¨“", addTag:"ã‚µã‚¤ã‚¨ãƒ³ã‚¹" },
      { re:/æ‰‹èŠ¸|ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰|ç·¨ã¿ç‰©|åˆºç¹/, addCat:"æ‰‹èŠ¸", addTag:"ãƒãƒ³ãƒ‰ãƒ¡ã‚¤ãƒ‰" },
      { re:/å·¥ä½œ|ã‚¯ãƒ©ãƒ•ãƒˆ|æœ¨å·¥/, addCat:"å·¥ä½œ", addTag:"ã‚¯ãƒ©ãƒ•ãƒˆ" },
      { re:/æ°´æ—é¤¨|å‹•ç‰©åœ’|æ˜†è™«|ç”Ÿãç‰©|ç”Ÿç‰©/, addCat:"ç”Ÿãç‰©", addTag:"æ°´æ—é¤¨" },
      { re:/ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢|å…¬åœ’|è‡ªç„¶|ãƒã‚¤ã‚­ãƒ³ã‚°/, addCat:"ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢", addTag:"è‡ªç„¶" }
    ];
    likeMap.forEach(rule=>{
      if (rule.re.test(text)) {
        if (!profile.interests.categories.includes(rule.addCat)) profile.interests.categories.push(rule.addCat);
        if (!profile.interests.tags.includes(rule.addTag)) profile.interests.tags.push(rule.addTag);
      }
    });

    // 5) æ™‚é–“å¸¯/æ›œæ—¥
    if (/åˆå‰(ä¸­)?ãŒ?å…ƒæ°—|åˆå‰/.test(text)) pushUniq(profile.basic.preferredDaysOut, "å¹³æ—¥åˆå‰");
    if (/åœŸæ›œ(ã®)?åˆå¾Œ|åœŸæ›œåˆå¾Œ/.test(text)) pushUniq(profile.basic.preferredDaysOut, "åœŸæ›œåˆå¾Œ");

    // 6) åŒä¼´/å‹é”
    if (/ä¿è­·è€…åŒä¼´(ãŒ)?å¿…è¦|ä»˜ãæ·»ã„(ãŒ)?å¿…è¦/.test(text)) profile.social.needsGuardian = true;
    if (/å‹(ã ã¡|é”)ã¨ä¸€ç·’OK|å‹é”OK|å‹ã ã¡OK/.test(text)) profile.social.friendTogetherOk = true;

    // 7) ã‚°ãƒ«ãƒ¼ãƒ—è¦æ¨¡
    if (/å°‘äººæ•°|å°è¦æ¨¡/.test(text)) profile.social.preferredGroupSize = "å°‘äººæ•°";

    // 8) ãƒãƒ¼ãƒˆ
    const notes = [];
    if (profile.constraints.noiseSensitivity) notes.push("å¤§éŸ³é‡ãŒè‹¦æ‰‹");
    if (profile.constraints.crowdAversion) notes.push("äººæ··ã¿ãŒè‹¦æ‰‹");
    if (/åˆå‰/.test(text)) notes.push("åˆå‰ãŒå…ƒæ°—");
    if (notes.length) profile.safetyAndNotes = Array.from(new Set((profile.safetyAndNotes + " " + notes.join(" ")).trim().split(/\s+/))).join(" ");

    profile.lastUpdated = new Date().toISOString();
    return profile;
  }
  function pushUniq(arr, v){ if(!arr.includes(v)) arr.push(v); }

  // ---- UIãƒ˜ãƒ«ãƒ‘ ----
  function renderMessages() {
    const box = $("messages");
    box.innerHTML = "";
    messages.forEach(m=>{
      const div = document.createElement("div");
      div.className = "msg " + (m.role==="parent"?"me":"");
      div.textContent = (m.role==="parent"?"ğŸ‘¤ ":"") + m.text;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  }
  function setProfile(profile){ $("profileJson").textContent = JSON.stringify(profile, null, 2); }
  function getProfile(){ try { return JSON.parse($("profileJson").textContent||"{}"); } catch(e){ return {}; } }

  // ---- Firebase ãƒ­ã‚°ã‚¤ãƒ³/å­ä½œæˆ/ä¿å­˜ ----
  $("loginBtn").onclick = async () => { await signInAnonymously(auth); };

  onAuthStateChanged(auth, async user=>{
    if (user){ uid = user.uid; $("uid").textContent = uid; await loadChildren(); }
  });

  async function loadChildren() {
    const col = collection(db, "parents", uid, "children");
    const snap = await getDocs(col);
    const list = [];
    snap.forEach(d=>list.push({ id:d.id, ...d.data() }));
    renderChildren(list);
  }

  function renderChildren(list){
    const wrap = $("childrenList");
    wrap.innerHTML = "";
    if (!list.length){ wrap.textContent = "ï¼ˆã¾ã ã„ã¾ã›ã‚“ï¼‰"; return; }
    list.forEach(c=>{
      const btn = document.createElement("button");
      btn.textContent = `${c.displayName || "(ãªãªã—)"} ã‚’é¸æŠ`;
      btn.onclick = async ()=>{
        currentChildId = c.id;
        $("currentChild").textContent = `${c.displayName || "(ãªãªã—)"}ï¼ˆ${c.id}ï¼‰`;
        // æ—¢å­˜ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­è¾¼
        const ref = doc(db, "parents", uid, "profiles", currentChildId);
        const snap = await getDoc(ref);
        setProfile(snap.exists()? snap.data() : emptyProfile(currentChildId));
      };
      wrap.appendChild(btn);
    });
  }

  $("createChildBtn").onclick = async ()=>{
    if(!uid){ alert("å…ˆã«åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"); return; }
    const name = $("childName").value.trim() || "ãªãªã—";
    const age = $("childAge").value? Number($("childAge").value) : null;
    const ref = await addDoc(collection(db, "parents", uid, "children"), { displayName:name, age, createdAt: serverTimestamp() });
    currentChildId = ref.id;
    $("currentChild").textContent = `${name}ï¼ˆ${ref.id}ï¼‰`;
    setProfile(emptyProfile(currentChildId));
    await loadChildren();
    alert("ä½œæˆã—ã¾ã—ãŸã€‚ãƒãƒ£ãƒƒãƒˆã§ãƒ¡ãƒ¢ã‚’é€ã£ã¦ã¿ã¦ãã ã•ã„ã€‚");
  };

  $("sendBtn").onclick = ()=>{
    if(!currentChildId){ alert("å­ã©ã‚‚ã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
    const t = $("chatInput").value.trim();
    if(!t) return;
    messages.push({ role:"parent", text:t });
    renderMessages();
    $("chatInput").value = "";
    // ãƒ«ãƒ¼ãƒ«æŠ½å‡ºã—ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åæ˜ 
    const prof = getProfile().childId? getProfile() : emptyProfile(currentChildId);
    const next = extractFromMessages(prof, messages);
    setProfile(next);
  };

  // ã‚¢ã‚·ã‚¹ãƒˆãƒãƒƒãƒ—
  document.querySelectorAll(".chip").forEach(ch=>{
    ch.onclick = ()=>{
      const inp = $("chatInput");
      inp.value = (inp.value? inp.value + " " : "") + ch.textContent;
      inp.focus();
    };
  });

  $("saveBtn").onclick = async ()=>{
    if(!uid || !currentChildId){ alert("ãƒ­ã‚°ã‚¤ãƒ³/å­ã©ã‚‚é¸æŠãŒå¿…è¦ã§ã™"); return; }
    try{
      const edited = JSON.parse($("profileJson").textContent);
      await setDoc(doc(db, "parents", uid, "profiles", currentChildId), edited, { merge:true });
      alert("Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ");
    }catch(e){
      alert("JSONãŒä¸æ­£ã§ã™ã€‚ç·¨é›†ç®‡æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  };

  $("reloadBtn").onclick = async ()=>{
    if(!uid || !currentChildId) return;
    const snap = await getDoc(doc(db, "parents", uid, "profiles", currentChildId));
    if (snap.exists()) setProfile(snap.data());
  };
</script>
</body>
</html>

