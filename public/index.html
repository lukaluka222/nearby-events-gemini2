<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>近所イベント検索（相模原）</title>
  <style>
    :root{
  /* Light Theme Palette */
  --bg:#f7fafc;          /* ページ背景 */
  --card:#ffffff;        /* カード/ヘッダー/フッター */
  --ink:#0b1b28;         /* 本文テキスト */
  --muted:#5b6b7a;       /* 補助テキスト */
  --line:#e3edf5;        /* 枠線/区切り線 */
  --accent:#2b8cff;      /* メインアクセント */
  --ok:#10b981;          /* 成功色 */
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:linear-gradient(180deg,#f7fafc,#f3f8fd); /* 明るい背景グラデ */
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP",sans-serif
}

/* Header */
header{
  position:sticky;top:0;z-index:5;
  background:rgba(255,255,255,.9);
  backdrop-filter:blur(8px);
  border-bottom:1px solid var(--line)
}
.hrow{display:flex;gap:8px;align-items:center;padding:10px 12px}
.logo{font-weight:700;letter-spacing:.02em}
.loc{margin-left:auto;font-size:12px;color:var(--muted)}

/* Search */
.search{display:flex;gap:8px;padding:6px 12px 12px}
.search input{
  flex:1;padding:12px;border-radius:12px;
  border:1px solid var(--line);
  background:#ffffff;
  color:var(--ink)
}
.btn{
  display:inline-flex;align-items:center;gap:6px;padding:10px 12px;
  border-radius:12px;border:1px solid var(--line);
  background:#ffffff;color:var(--ink);cursor:pointer;
  box-shadow:0 1px 0 rgba(0,0,0,.02)
}
.btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
.btn.primary{
  background:linear-gradient(90deg,#2b8cff,#6ab6ff);
  color:#ffffff;border:0;font-weight:700
}

/* Chips */
.toolbar{display:flex;gap:8px;padding:0 12px 8px;overflow-x:auto}
.chip{
  white-space:nowrap;border:1px solid var(--line);
  background:#ffffff;padding:8px 10px;border-radius:999px;
  font-size:13px;cursor:pointer;color:var(--ink)
}
.chip.active{outline:2px solid #cfe3ff;background:#f0f6ff}

/* Main */
main{padding:10px;max-width:680px;margin:0 auto}
.cards{display:grid;grid-template-columns:1fr;gap:10px}
.card{
  border:1px solid var(--line);
  background:var(--card);
  border-radius:16px;overflow:hidden;
  box-shadow:0 2px 14px rgba(0,0,0,.05)
}
.ph{
  height:140px;
  background:linear-gradient(120deg,rgba(43,140,255,.12),rgba(16,185,129,.10));
  border-bottom:1px solid var(--line)
}
.body{padding:10px 12px}
h3{margin:2px 0 6px;font-size:16px}
.meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
.tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.tag{
  font-size:11px;background:#e8f2ff;border:1px solid #d7e6ff;
  border-radius:999px;padding:3px 8px;color:#0b3a74
}
.cta{display:flex;gap:8px;padding:10px 12px 12px}
.score{
  margin-left:auto;font-weight:700;color:#065f46;
  background:#d1fae5;border:1px solid #a7f3d0;border-radius:10px;padding:4px 8px
}

/* Skeleton (読み込み中) */
.skeleton{
  height:92px;border:1px solid var(--line);border-radius:14px;
  background:linear-gradient(90deg,#eef5fb 0%,#e6f0fb 40%,#eef5fb 80%);
  background-size:200% 100%;animation:sk 1.2s infinite
}
@keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* Footer */
footer{
  position:sticky;bottom:0;
  background:rgba(255,255,255,.9);
  backdrop-filter:blur(8px);
  border-top:1px solid var(--line);padding:8px 12px
}
.sources{display:flex;gap:8px;overflow-x:auto}
.src{
  white-space:nowrap;font-size:12px;border:1px solid var(--line);
  padding:8px 10px;border-radius:10px;background:#ffffff;color:var(--ink);
  text-decoration:none
}
.muted{color:var(--muted)}

  </style>
</head>
<body>
  <header>
    <div class="hrow">
      <div class="logo">近所イベント（相模原）</div>
      <div class="loc" id="loc">位置未取得</div>
    </div>
    <div class="search">
      <input id="q" placeholder="例：苔／手芸／木工／花屋／科学館" />
      <button class="btn" id="geo">現在地</button>
      <button class="btn primary" id="go">検索</button>
    </div>
    <div class="toolbar" id="chips"></div>
  </header>

  <main>
    <div id="list" class="cards"></div>
    <div id="empty" class="muted" style="padding:12px;display:none">（APIが空です）キーワードを変える／再検索してください。</div>
  </main>

  <footer>
    <div class="sources" id="sources"></div>
  </footer>

<script>
// プリセットチップ
const PRESETS = ["苔","手芸","編み物","木工","花屋","科学館","ガラス","竹細工","自然観察"];

// 位置
const locEl = document.getElementById('loc');
let LOC = { lat:35.5710, lon:139.3707 };
function updateLocLabel(){ locEl.textContent = `${LOC.lat.toFixed(3)}, ${LOC.lon.toFixed(3)}` }
updateLocLabel();

// 距離
function dist(a,b){
  const R=6371, toRad=d=>d*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
  const la=toRad(a.lat), lb=toRad(b.lat);
  const h=Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}

// 描画（API結果のみ）
function render(items){
  const list=document.getElementById('list');
  const empty=document.getElementById('empty');
  list.innerHTML='';
  if(!items.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  items.forEach(({it,meta})=>{
    const tags = (it.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('');
    const el=document.createElement('article'); el.className='card';
    el.innerHTML = `
      <div class="ph"></div>
      <div class="body">
        <h3>${it.title||'（無題）'}</h3>
        <div class="meta">
          <span>${it.source||'API'}</span>
          <span>${it.place||''}</span>
          <span>距離 ${meta.d??'?'}km</span>
          <span>価格 ${typeof it.price==='number' ? (it.price+'円') : '無料/未定'}</span>
          <span>目安 ${it.when||'要確認'}</span>
          <span class="score">${meta.s??0}</span>
        </div>
        <div class="tags">${tags}</div>
      </div>
      <div class="cta">
        <button class="btn" onclick="openMap(${it.lat||LOC.lat},${it.lon||LOC.lon}, '${(it.title||'').replace(/'/g,"\\'")}')">地図</button>
        <a class="btn primary" href="${it.url||'#'}" target="_blank" rel="noopener">予約/詳細</a>
      </div>`;
    list.appendChild(el);
  });
}
function openMap(lat,lon,title){
  const q=encodeURIComponent(`${lat},${lon} (${title})`);
  window.open(`https://www.google.com/maps/search/?api=1&query=${q}`,'_blank');
}

// 検索（APIのみ。ローカル固定データのフォールバックは完全停止）
async function search(){
  const q = document.getElementById('q').value.trim();
  const list = document.getElementById('list');
  list.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>';

  const url = new URL('/api/events', window.location.origin);
  url.searchParams.set('q', q || '');
  url.searchParams.set('lat', LOC.lat);
  url.searchParams.set('lon', LOC.lon);
  url.searchParams.set('radius', 8);
  url.searchParams.set('fresh', '1');
  url.searchParams.set('debug', '0');

  try {
    const res = await fetch(url);
    const data = await res.json();
    console.log('API result', data);

    if (Array.isArray(data) && data.length) {
      const ranked = data.map(it => {
        const d = (typeof it.distance_km === 'number') ? it.distance_km.toFixed(1) : '?';
        return {
          it: {
            title: it.title || '（無題）',
            tags: Array.isArray(it.tags) ? it.tags : [],
            place: it.place || '',
            lat: (typeof it.lat === 'number') ? it.lat : LOC.lat,
            lon: (typeof it.lon === 'number') ? it.lon : LOC.lon,
            price: (typeof it.price === 'number') ? it.price : null,
            when: it.when || '',
            url: it.url || '#',
            source: 'API'
          },
          meta: { s: it.score ?? 0, d }
        };
      });
      render(ranked);
      updateSourceLinks(q);
      return;
    }
    console.log('API empty');
    render([]); // ← 空は空のまま
    updateSourceLinks(q);
  } catch (e) {
    console.warn('API error', e);
    render([]); // ← フォールバックしない
    updateSourceLinks(q);
  }
}

// 位置取得ボタン
document.getElementById('geo').addEventListener('click',()=>{
  if(!navigator.geolocation){alert('位置情報が使えません');return}
  navigator.geolocation.getCurrentPosition((p)=>{
    LOC={lat:p.coords.latitude,lon:p.coords.longitude};
    updateLocLabel();
    search();
  },(e)=>{alert('位置情報の取得に失敗しました');console.warn(e)},{enableHighAccuracy:true,timeout:8000});
});

// プリセットチップ
const chipsEl=document.getElementById('chips');
PRESETS.forEach(t=>{
  const b=document.createElement('button'); b.className='chip'; b.textContent=t;
  b.addEventListener('click',()=>{
    document.getElementById('q').value=t;
    search();
    [...document.querySelectorAll('.chip')].forEach(c=>c.classList.toggle('active', c.textContent===t));
  });
  chipsEl.appendChild(b);
});

// 検索ボタン/Enter
document.getElementById('go').addEventListener('click', search);
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(); });

// フッターリンク
function updateSourceLinks(q){
  const area = '相模原';
  const kw = encodeURIComponent(q||'体験 ワークショップ');
  const box=document.getElementById('sources');
  box.innerHTML='';
  const links=[
    {name:'じゃらん', url:`https://www.jalan.net/kankou/?word=${kw}`},
    {name:'相模原市 公式', url:`https://www.google.com/search?q=${encodeURIComponent('site:city.sagamihara.kanagawa.jp ')}${kw}`},
    {name:'YouTube', url:`https://www.youtube.com/results?search_query=${encodeURIComponent(area+' '+(q||'作ってみた 体験'))}`}
  ];
  links.forEach(l=>{
    const a=document.createElement('a'); a.href=l.url; a.target='_blank'; a.rel='noopener'; a.className='src'; a.textContent=l.name+'で探す'; box.appendChild(a);
  })
}
updateSourceLinks('');
</script>
</body>
</html>
