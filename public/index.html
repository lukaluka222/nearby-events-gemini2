<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>近所イベント検索（相模原）</title>
  <style>
    /* === モバイル1画面設計：ヘッダー＋ツールバー＋カード一覧のみ === */
    :root{--bg:#0b1116;--card:#111a22;--ink:#e8f0f7;--muted:#9fb2c3;--line:#1a2a36;--accent:#4cc3ff;--ok:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#071018,#0b1116);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP",sans-serif}
    header{position:sticky;top:0;z-index:5;background:rgba(7,16,24,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
    .hrow{display:flex;gap:8px;align-items:center;padding:10px 12px}
    .logo{font-weight:700;letter-spacing:.02em}
    .loc{margin-left:auto;font-size:12px;color:var(--muted)}
    .search{display:flex;gap:8px;padding:6px 12px 12px}
    .search input{flex:1;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0a141c;color:var(--ink)}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0c1620;color:var(--ink);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#21a1f1,#4cc3ff);color:#05131c;border:0;font-weight:700}
    .toolbar{display:flex;gap:8px;padding:0 12px 8px;overflow-x:auto}
    .chip{white-space:nowrap;border:1px solid var(--line);background:#0c1620;padding:8px 10px;border-radius:999px;font-size:13px;cursor:pointer}
    .chip.active{outline:2px solid #1d3647;background:#0e1c26}

    main{padding:10px;max-width:680px;margin:0 auto}
    .cards{display:grid;grid-template-columns:1fr;gap:10px}
    .card{border:1px solid var(--line);background:linear-gradient(180deg,#0e1821,#0b141c);border-radius:16px;overflow:hidden}
    .ph{height:140px;background:linear-gradient(120deg,rgba(76,195,255,.25),rgba(110,231,183,.15));border-bottom:1px solid var(--line)}
    .body{padding:10px 12px}
    h3{margin:2px 0 6px;font-size:16px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .tag{font-size:11px;color:#072133;background:#cfefff;border-radius:999px;padding:3px 8px;color:#062033}
    .cta{display:flex;gap:8px;padding:10px 12px 12px}
    .score{margin-left:auto;font-weight:700;color:#041016;background:#a7f3d0;border-radius:10px;padding:4px 8px}

    .skeleton{height:92px;border:1px solid var(--line);border-radius:14px;background:linear-gradient(90deg,#0f1a23 0%,#122030 40%,#0f1a23 80%);background-size:200% 100%;animation:sk 1.2s infinite}
    @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}

    footer{position:sticky;bottom:0;background:rgba(7,16,24,.9);backdrop-filter:blur(6px);border-top:1px solid var(--line);padding:8px 12px}
    .sources{display:flex;gap:8px;overflow-x:auto}
    .src{white-space:nowrap;font-size:12px;border:1px solid var(--line);padding:8px 10px;border-radius:10px;background:#0c1620}

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <!-- ヘッダー：タイトル＋現在地 -->
  <header>
    <div class="hrow">
      <div class="logo">近所イベント（相模原）</div>
      <div class="loc" id="loc">位置未取得</div>
    </div>
    <div class="search">
      <input id="q" placeholder="例：苔／手芸／木工／花屋／科学館" />
      <button class="btn" id="geo">現在地</button>
      <button class="btn primary" id="go">検索</button>
    </div>
    <div class="toolbar" id="chips">
      <!-- よく使うキーワードをワンタップで -->
    </div>
  </header>

  <!-- カード一覧（1画面で見切れる量に） -->
  <main>
    <div id="list" class="cards"></div>
    <div id="empty" class="muted" style="padding:12px;display:none">候補が見つからなければ、キーワードを変えてみてください。</div>
  </main>

  <!-- フッター：ソースへ飛ぶクイックリンク。Gemini統合後も残せる設計 -->
  <footer>
    <div class="sources" id="sources"></div>
  </footer>

<script>
/**
 * スマホ1画面MVP
 * - プロフィール入力なし
 * - キーワード＋現在地から「手元データ」をスコアリング表示
 * - 将来：GeminiでWebから拾った候補を addFromGemini() に流し込む
 */

// よく使うキーワード（チップ）
const PRESETS = ["苔","手芸","編み物","木工","花屋","科学館","ガラス","竹細工","自然観察"];

// サンプル候補（最初は手書きでOK。後でGeminiの結果をここにpush）
const CATALOG = [
  {title:"ふじのアート工房 木工フリーワーク", tags:["木工","初心者OK","屋内","小規模"], place:"相模原市緑区", lat:35.5816, lon:139.2065, price:1000, when:"土日中心（要予約）", url:"https://www.google.com/search?q=%E3%81%B5%E3%81%98%E3%81%AE%E3%82%A2%E3%83%BC%E3%83%88%E5%B7%A5%E6%88%BF+%E4%BD%93%E9%A8%93"},
  {title:"相模川ふれあい科学館 かんたん工作", tags:["科学館","初心者OK","屋内"], place:"相模原市緑区", lat:35.5924, lon:139.3189, price:500, when:"平日午後/週末", url:"https://www.google.com/search?q=%E7%9B%B8%E6%A8%A1%E5%B7%9D%E3%81%B5%E3%82%8C%E3%81%82%E3%81%84%E7%A7%91%E5%AD%A6%E9%A4%A8+%E5%B7%A5%E4%BD%9C"},
  {title:"花屋のミニブーケづくり", tags:["花屋","初心者OK","屋内","小規模"], place:"市内複数店舗", lat:35.566, lon:139.39, price:1500, when:"不定期（SNS告知）", url:"https://www.google.com/search?q=%E7%9B%B8%E6%A8%A1%E5%8E%9F+%E3%83%95%E3%83%A9%E3%83%AF%E3%83%BC+%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%83%E3%83%97"},
  {title:"相模川 こけ観察ミッション（自発）", tags:["苔","自然観察","屋外","人少なめ","短時間OK"], place:"新磯〜高田橋の河原", lat:35.5416, lon:139.3608, price:0, when:"晴れた日の午後30〜60分", url:"https://www.google.com/search?q=%E7%9B%B8%E6%A8%A1%E5%B7%9D+%E6%B2%B3%E5%8E%9F+%E8%87%AA%E7%99%BA+%E8%8B%94"},
  {title:"食品サンプルづくり（アトリエ）", tags:["手芸","初心者OK","屋内"], place:"相模原/町田周辺", lat:35.5710, lon:139.3707, price:2000, when:"随時（予約制）", url:"https://www.google.com/search?q=%E9%A3%9F%E5%93%81%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB+%E4%BD%93%E9%A8%93+%E7%9B%B8%E6%A8%A1%E5%8E%9F"},
  {title:"図書館×編み物 30分ミッション", tags:["編み物","裁縫","屋内","短時間OK"], place:"市内図書館", lat:35.5710, lon:139.3707, price:0, when:"開館日の午後", url:"https://www.google.com/search?q=%E7%9B%B8%E6%A8%A1%E5%8E%9F+%E5%9B%B3%E6%9B%B8%E9%A4%A8+%E7%B7%A8%E3%81%BF%E7%89%A9"}
];

// 位置取得と表示
const locEl=document.getElementById('loc');
let LOC={lat:35.5710, lon:139.3707}; // 相模原駅あたりを初期値

function updateLocLabel(){locEl.textContent=`${LOC.lat.toFixed(3)}, ${LOC.lon.toFixed(3)}`}
updateLocLabel();

// Haversine（距離km）
function dist(a,b){
  const R=6371; const toRad=d=>d*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
  const la=toRad(a.lat), lb=toRad(b.lat);
  const h=Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}

// スコアリング（超シンプル）：距離＋タグ一致
function score(item, q){
  const d = dist(LOC,{lat:item.lat,lon:item.lon});
  let s = 0;
  if (d<=3) s+=15; else if(d<=5) s+=10; else if(d<=10) s+=6; else s+=2;
  if(q){
    const hit = (item.title+" "+item.tags.join(" ")).includes(q);
    if(hit) s+=12;
  }
  return {s, d: d.toFixed(1)};
}

// 描画
function render(items){
  const list=document.getElementById('list');
  const empty=document.getElementById('empty');
  list.innerHTML='';
  if(!items.length){ empty.style.display='block'; return; }
  empty.style.display='none';
  items.forEach(({it,meta})=>{
    const tags = it.tags.map(t=>`<span class="tag">${t}</span>`).join('');
    const el=document.createElement('article'); el.className='card';
    el.innerHTML = `
      <div class="ph"></div>
      <div class="body">
        <h3>${it.title}</h3>
        <div class="meta">
          <span>${it.place}</span>
          <span>距離 ${meta.d}km</span>
          <span>価格 ${it.price?it.price+"円":"無料/未定"}</span>
          <span>目安 ${it.when||'要確認'}</span>
          <span class="score">${meta.s}</span>
        </div>
        <div class="tags">${tags}</div>
      </div>
      <div class="cta">
        <button class="btn" onclick="openMap(${it.lat},${it.lon}, '${it.title.replace(/'/g,"\'")}')">地図</button>
        <a class="btn primary" href="${it.url}" target="_blank" rel="noopener">予約/詳細</a>
      </div>`;
    list.appendChild(el);
  });
}

function openMap(lat,lon,title){
  const q=encodeURIComponent(`${lat},${lon} (${title})`);
  window.open(`https://www.google.com/maps/search/?api=1&query=${q}`,'_blank');
}

<script>
async function search(){
  const q = document.getElementById('q').value.trim();
  const list = document.getElementById('list');
  list.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>';

  // APIを叩く（same-origin の /api/events）
  const url = new URL('/api/events', window.location.origin);
  url.searchParams.set('q', q || '');
  url.searchParams.set('lat', LOC.lat);
  url.searchParams.set('lon', LOC.lon);
  url.searchParams.set('radius', 8);
  url.searchParams.set('fresh', '1');   // 毎回新規抽出（テスト時便利）
  url.searchParams.set('debug', '0');   // 1にすると内部情報が返る（画面描画には使わない）

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (Array.isArray(data) && data.length) {
      // --- API結果をそのまま描画 ---
      const ranked = data.map(it => ({
        it: {
          title: it.title || '（無題）',
          tags: Array.isArray(it.tags) ? it.tags : [],
          place: it.place || '',
          lat: (typeof it.lat === 'number') ? it.lat : LOC.lat,
          lon: (typeof it.lon === 'number') ? it.lon : LOC.lon,
          price: (typeof it.price === 'number') ? it.price : null,
          when: it.when || '',
          url: it.url || '#'
        },
        meta: { s: it.score ?? 0, d: (it.distance_km ?? 99).toString() }
      }));
      render(ranked);
      updateSourceLinks(q);
      console.log('from API', data.length);
      return;
    }

    // APIが空配列→フォールバック
    console.log('API empty → fallback');
    const ranked = CATALOG.map(it => ({ it, meta: score(it, q) }))
                          .sort((a,b)=>b.meta.s-a.meta.s).slice(0,6);
    render(ranked);
    updateSourceLinks(q);
  } catch (e) {
    console.warn('API error', e);
    // 通信失敗→フォールバック
    const ranked = CATALOG.map(it => ({ it, meta: score(it, q) }))
                          .sort((a,b)=>b.meta.s-a.meta.s).slice(0,6);
    render(ranked);
    updateSourceLinks(q);
  }
}
</script>


// 現在地ボタン
document.getElementById('geo').addEventListener('click',()=>{
  if(!navigator.geolocation){alert('位置情報が使えません');return}
  navigator.geolocation.getCurrentPosition((p)=>{
    LOC={lat:p.coords.latitude,lon:p.coords.longitude};
    updateLocLabel();
    search();
  },(e)=>{alert('位置情報の取得に失敗しました');console.warn(e)},{enableHighAccuracy:true,timeout:8000});
});

// プリセットチップ
const chipsEl=document.getElementById('chips');
PRESETS.forEach(t=>{
  const b=document.createElement('button'); b.className='chip'; b.textContent=t; b.addEventListener('click',()=>{document.getElementById('q').value=t; search(); chipsSetActive(t);});
  chipsEl.appendChild(b);
});
function chipsSetActive(t){
  [...document.querySelectorAll('.chip')].forEach(c=>c.classList.toggle('active', c.textContent===t));
}

// 初回描画
render(CATALOG.map(it=>({it,meta:score(it,'')})));

// 検索ボタン
 document.getElementById('go').addEventListener('click', search);
 document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') search();});

// --- フッター：ソースリンクを動的生成（じゃらん/市サイト/YouTube） ---
function updateSourceLinks(q){
  const area = '相模原';
  const kw = encodeURIComponent(q||'体験 ワークショップ');
  const box=document.getElementById('sources');
  box.innerHTML='';
  const links=[
    {name:'じゃらん', url:`https://www.jalan.net/kankou/?word=${kw}`},
    {name:'相模原市 公式', url:`https://www.google.com/search?q=${encodeURIComponent('site:city.sagamihara.kanagawa.jp ')}${kw}`},
    {name:'YouTube', url:`https://www.youtube.com/results?search_query=${encodeURIComponent(area+' '+(q||'作ってみた 体験'))}`}
  ];
  links.forEach(l=>{
    const a=document.createElement('a'); a.href=l.url; a.target='_blank'; a.rel='noopener'; a.className='src'; a.textContent=l.name+'で探す'; box.appendChild(a);
  })
}
updateSourceLinks('');

// === 将来：Gemini 連携の入り口（初心者向けに解説付き） ===
/**
 * addFromGemini(results)
 * - Geminiが返した候補（タイトル/説明/場所/緯度経度/URL/タグ）を CATALOG に追加して search() を再実行
 * - まずはブラウザ内だけで体験。サーバー不要。
 *
 * 例）Geminiレスポンスを仮定：
 * const results=[{
 *   title: "市立公民館 手芸ワークショップ",
 *   tags: ["手芸","屋内","小規模"],
 *   place: "相模原市中央区",
 *   lat: 35.57, lon: 139.37,
 *   price: 500, when: "第2土曜 午後",
 *   url: "https://..."
 * }];
 * addFromGemini(results);
 */
function addFromGemini(results){
  if(!Array.isArray(results)) return;
  results.forEach(r=>CATALOG.push(r));
  search();
}

</script>
</body>
</html>
